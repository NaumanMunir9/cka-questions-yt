# Question 15

Write a command into `/tmp/opt/course/15/cluster_events.sh` which shows the latest events in the whole cluster, ordered by time (`metadata.creationTimestamp`). Use `kubectl` for it.

Now kill the kube-proxy Pod running on node `kind-worker` and write the events this caused into `/tmp/opt/course/15/pod_kill.log`.

Finally kill the containerd container of the kube-proxy Pod on node `kind-worker` and write the event into `/tmp/opt/course/15/container_kill.log`.

Do you notice differences in the events both actions caused?

---

---

This CKA practice question asks you to gather events caused by killing a Kubernetes component (`kube-proxy`), and analyze the differences in events generated by two different methods of killing the same Pod: via Kubernetes (`kubectl delete`) and directly by killing the container.

Here's the step-by-step guide:

### Step 1: Create the script to list cluster events ordered by time

1. **Create or edit the script `/opt/course/15/cluster_events.sh`**. This script will use `kubectl` to list the latest events in the cluster, ordered by `metadata.creationTimestamp`. Run the following command to create the script:

   ```bash
   vi /opt/course/15/cluster_events.sh
   ```

2. **Add the following command to the script**:

   ```bash
   #!/bin/bash
   kubectl get events --all-namespaces --sort-by=.metadata.creationTimestamp
   ```

3. **Save the script** and exit the editor.

4. **Make the script executable**:

   ```bash
   chmod +x /opt/course/15/cluster_events.sh
   ```

5. **Run the script to verify it works**:

   ```bash
   /opt/course/15/cluster_events.sh
   ```

   This will show the latest events in the cluster, sorted by creation time.

### Step 2: Kill the kube-proxy Pod running on `kind-worker` node

1. **Identify the kube-proxy Pod** running on the `kind-worker` node:

   ```bash
   kubectl get pods -n kube-system -o wide | grep kube-proxy
   ```

   This will give you the name of the `kube-proxy` Pod running on `kind-worker`.

2. **Delete the kube-proxy Pod** on the `kind-worker` node using `kubectl`:

   ```bash
   kubectl delete pod <kube-proxy-pod-name> -n kube-system
   ```

3. **Capture the events caused by this deletion**:
   - After deleting the Pod, run the following command to capture the relevant events and write them to the log file `/opt/course/15/pod_kill.log`:

   ```bash
   /opt/course/15/cluster_events.sh > /opt/course/15/pod_kill.log
   ```

   This will log all cluster events, including those caused by killing the kube-proxy Pod via `kubectl`.

### Step 3: Kill the containerd container of kube-proxy directly

1. **SSH into the `kind-worker` node** (if necessary) or access it directly.

2. **Find the container ID** of the kube-proxy Pod's container using `containerd`:

   ```bash
   crictl ps | grep kube-proxy
   ```

   This will give you the container ID of the `kube-proxy` container running on `kind-worker`.

3. **Kill the kube-proxy container** directly using `crictl`:

   ```bash
   crictl rm <container-id>
   ```

4. **Capture the events caused by this container termination**:
   - After killing the container, run the following command to log the events into `/opt/course/15/container_kill.log`:

   ```bash
   /opt/course/15/cluster_events.sh > /opt/course/15/container_kill.log
   ```

### Step 4: Compare the events

1. **Inspect the logs** from both actions:

   ```bash
   cat /opt/course/15/pod_kill.log
   cat /opt/course/15/container_kill.log
   ```

2. **Notice the differences** in the events caused by both actions:
   - **Pod deletion via `kubectl delete pod`**: This will trigger Kubernetes-managed events like graceful shutdown, container stopping, and new scheduling actions.
   - **Container deletion via `crictl rm`**: This bypasses Kubernetes' control, so you may see different events, such as container restart actions triggered by the kubelet but without graceful Pod deletion events.

### Conclusion:

By following these steps, you'll have a clear understanding of how different methods of killing a Pod (through Kubernetes and directly killing the container) affect the cluster and the events generated.
